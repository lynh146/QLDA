<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8">
<title>Truy xuất nguồn gốc – Chôm chôm</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">
<style>
  :root{--brand:#198754;}
  body{background:#f6f8fb;}
  .hero{background: radial-gradient(1100px 350px at 10% -10%, rgba(25,135,84,.12), transparent);}
  .card-soft{border:1px solid rgba(0,0,0,.06); border-radius:1rem;}
  .muted{color:#6c757d}
  .badge-soft{background:#ecf7f0;color:#198754;border:1px solid #cfe9da}
</style>
</head>
<body>

<nav class="navbar navbar-expand-lg bg-white shadow-sm">
  <div class="container">
    <a class="navbar-brand fw-bold" href="./">Chôm Chôm</a>
    <div class="ms-auto d-flex gap-2">
      <a class="btn btn-success btn-sm" href="./views/login.html"><i class="fa-solid fa-right-to-bracket me-1"></i>Đăng nhập</a>
    </div>
  </div>
</nav>

<section class="hero py-5">
  <div class="container">
    <div class="row align-items-center gy-3">
      <div class="col-lg-7">
        <h1 class="fw-bold mb-2">Truy xuất nguồn gốc chôm chôm</h1>
<p class="muted mb-4">
  Nhập <b>Tên nông dân</b>, <b>Tên vườn</b> hoặc <b>Tên giống</b> để xem:
  <span class="badge badge-soft rounded-pill px-2 ms-1">Thông tin người trồng</span>
  <span class="badge badge-soft rounded-pill px-2 ms-1">Lịch sử thu hoạch</span>
  <span class="badge badge-soft rounded-pill px-2 ms-1">Nhật ký canh tác</span>
</p>

<form class="row g-2" id="frmTrace">
  <div class="col-md-8">
    <input id="q" class="form-control form-control-lg" placeholder="Nhập tên nông dân, tên vườn hoặc tên giống...">
  </div>
  <div class="col-md-4 d-grid">
    <button class="btn btn-lg btn-success">
      <i class="fa-solid fa-magnifying-glass me-2"></i>Truy xuất
    </button>
  </div>
</form>


        <div id="msg" class="text-danger mt-2" style="display:none"></div>
      </div>
      
    </div>
  </div>
</section>

<!-- Kết quả -->
<section class="py-4">
  <div class="container">
    <!-- 1) Thông tin người trồng -->
    <div class="card-soft bg-white p-3 mb-3">
      <h5 class="mb-3"><i class="fa-solid fa-user-tree me-2 text-success"></i>Thông tin người trồng</h5>
      <div id="farmerBox" class="row g-3">
        <div class="col-12 text-muted">Chưa có dữ liệu. Vui lòng truy xuất.</div>
      </div>
    </div>

    <!-- 2) Lịch sử thu hoạch -->
    <div class="card-soft bg-white p-3 mb-3">
      <div class="d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="fa-solid fa-basket-shopping me-2 text-success"></i>Lịch sử thu hoạch</h5>
        <span id="traceTag" class="muted small"></span>
      </div>
      <div class="table-responsive mt-3">
        <table class="table table-bordered table-sm mb-0">
          <thead class="text-center">
            <tr><th>Mã TH</th><th>Mã Lô</th><th>Giống</th><th>Sản lượng (tấn)</th><th>Chất lượng</th><th>Ngày TH</th></tr>
          </thead>
          <tbody id="tbTH"><tr><td colspan="6" class="text-center text-muted">Chưa có dữ liệu.</td></tr></tbody>
        </table>
      </div>
    </div>

    <!-- 3) Nhật ký canh tác -->
    <div class="card-soft bg-white p-3">
      <h5 class="mb-3"><i class="fa-solid fa-clipboard-list me-2 text-success"></i>Nhật ký canh tác</h5>
      <ul id="ulNK" class="list-group">
        <li class="list-group-item text-muted">Chưa có dữ liệu.</li>
      </ul>
    </div>
  </div>
</section>

<footer class="py-4 mt-5 bg-white border-top">
  <div class="container d-flex justify-content-between">

  </div>
</footer>

<script>
document.getElementById('frmTrace').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const q = document.getElementById('q').value.trim();
  const msg = document.getElementById('msg');
  msg.style.display='none'; msg.textContent='';
  if(!q){ msg.textContent='Hãy nhập MaTX hoặc MaLo'; msg.style.display='block'; return; }

  // gọi API gộp (1 file duy nhất)
  try{
    const r = await fetch(`api/public/trace.php?q=${encodeURIComponent(q)}`, {headers:{'Accept':'application/json'}});
    const js = await r.json();

    // 1) Người trồng
    const box = document.getElementById('farmerBox');
    box.innerHTML = js.farmer ? `
      <div class="col-md-4">
        <div class="p-3 bg-light rounded h-100">
          <div class="muted small">Người trồng</div>
          <div class="h6 mb-0">${js.farmer.TenND||'-'}</div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="p-3 bg-light rounded h-100">
          <div class="muted small">Vườn</div>
          <div class="h6 mb-1">${js.farmer.TenVuon||'-'} <span class="muted">(${js.farmer.MaVuon||''})</span></div>
          <div class="muted small">Địa chỉ: ${js.farmer.DiaChi||'-'}</div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="p-3 bg-light rounded h-100">
          <div class="muted small">Liên hệ</div>
          <div class="h6 mb-0">${js.farmer.SDT||'-'}</div>
        </div>
      </div>` : `<div class="col-12 text-muted">Không tìm thấy thông tin người trồng.</div>`;

    // 2) Thu hoạch
    const tb = document.getElementById('tbTH');
    const th = js.thuhoach||[];
    tb.innerHTML = th.length ? th.map(x=>`
      <tr class="text-center">
        <td>${x.MaTH}</td><td>${x.MaLo}</td><td>${x.TenGiong||''}</td>
        <td>${x.SanLuong??''}</td><td>${x.ChatLuong||''}</td><td>${x.NgayTH||''}</td>
      </tr>`).join('') :
      '<tr><td colspan="6" class="text-center text-muted">Chưa có dữ liệu.</td></tr>';
    document.getElementById('traceTag').textContent = js.queryInfo || '';

    // 3) Nhật ký
    const ul = document.getElementById('ulNK');
    const nk = js.nhatky||[];
    ul.innerHTML = nk.length ? nk.map(x=>`
      <li class="list-group-item d-flex justify-content-between">
        <span>[${x.TrangThai||''}] ${x.TenCV||''}</span>
        <span class="muted">${x.NgayBD||''} → ${x.NgayKT||''}</span>
      </li>`).join('') :
      '<li class="list-group-item text-muted">Chưa có công việc.</li>';

  }catch(e){
    msg.textContent='Không truy xuất được dữ liệu.'; msg.style.display='block';
    console.log(e);
  }
});
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
